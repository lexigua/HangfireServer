var siChuanShengBorderArry= [{ Shape: "POLYGON ((102.30670993691422 33.975819650756421, 102.17996886676997 33.932905452424848, 102.47957748031666 33.459304987335486, 102.2598632326023 33.418114715621812, 102.08346308835104 33.226951931986264, 101.95047641005846 33.241149915836104, 101.8631584563978 33.105011817941204, 101.79582605113154 33.24443687855927, 101.94334065384828 33.442255926869677, 101.79049639079597 33.620477081352362, 101.63138090060824 33.104437569338529, 101.48342008666782 33.22883684534429, 101.16114992003298 33.161498838201, 101.12008063501349 32.91313810044312, 101.2197073100445 32.860696765843215, 101.21836588577719 32.724427347144513, 100.92748433473446 32.602324106872175, 100.68465072235313 32.67932095240019, 100.6585672290945 32.526768334091514, 100.39761959257032 32.757465551394262, 100.2576483736737 32.744912716249019, 100.21075175968616 32.608055000637933, 100.10747799111658 32.6412063566882, 100.10802447494973 32.862741718955306, 99.89635396776157 33.039459874273916, 99.767961064251892 32.947405437810858, 99.727938754669992 32.727292701397232, 99.265946868053675 32.880726862155143, 99.193026530650059 33.037898209634818, 98.828647844022953 33.1820005452891, 98.6553759060734 33.653133680774886, 98.461751784117723 33.849810071178013, 98.011997879099 33.951702972114617, 97.75911864071287 33.867414044822453, 97.781838031899838 33.973941474219828, 97.686079172815766 34.017893081900354, 97.367818629026658 33.826834248202147, 97.404389622982876 33.621413707276929, 97.550334068762425 33.468581484348192, 97.772838839940675 33.422964994139306, 97.4854968693852 33.169065573817363, 97.522135495057228 32.990636657056257, 97.360597468698415 32.9459354617523, 97.423253887656983 32.704975256802811, 98.217168869847626 32.344147795084837, 98.432508047108854 32.008660747395766, 98.41483979801842 31.831984332311265, 98.885013829025183 31.377537817916107, 98.776363037324472 31.250562739678855, 98.634491300033631 31.337105253804566, 98.600839190676254 31.190238791587149, 98.956410236443446 30.767097388933507, 98.903362676046811 30.6903672796264, 99.067126221398155 29.930732460035188, 98.990359943157046 29.662769519797678, 99.11393991429577 29.242060442435616, 99.173166059965865 28.405366209682995, 99.40007747229771 28.15390189985294, 99.381717987195543 28.544438440182034, 99.526380271332641 28.592129296729809, 99.717200314343188 28.847850097803928, 99.826236080630792 28.577964514051246, 99.94781986169744 28.581473246892983, 100.17411374375445 28.328062996610186, 100.16576766824346 28.223970062568526, 100.01987669435414 28.148549370657122, 100.16637967578157 27.900144584105419, 100.30646571472113 27.864144260349519, 100.32738688000069 27.723575791789528, 100.43007176170261 27.868299745137278, 100.54550921527823 27.812969029097587, 100.67874273319075 27.926349348244003, 101.05463922342159 27.203430141687875, 101.16700721171361 27.19931966527048, 101.13821440107392 27.029603118789055, 101.36254541563858 26.886944925268267, 101.39027232730621 26.725461734171859, 101.511329441101 26.770691139984308, 101.39309396371561 26.54781795703326, 101.63466377681203 26.398581935008451, 101.59160276055911 26.265451116076292, 101.80619961042385 26.163066408288273, 101.83336166870623 26.049047744957647, 102.10521073958415 26.071080784350897, 102.54867468009257 26.366045046142119, 102.67604586832232 26.209487550710037, 102.87791492173642 26.369540090403007, 102.98203894713987 26.348610396852507, 103.05335647142419 26.550267242639279, 102.89410121310067 26.915005601427538, 102.88073793410854 27.301098300146577, 102.94667124608134 27.416166153045708, 103.13978169956596 27.425059395874598, 103.48629595089761 27.800123323432786, 103.56097191062537 27.980282707581068, 103.42847455885396 28.04590524892825, 103.44769273822948 28.124006046442048, 103.87220604137588 28.308178832387398, 103.77930735195292 28.52715569268122, 103.84881875518158 28.67032889376361, 104.42144488107658 28.629929554205717, 104.24385345797089 28.528948310416354, 104.28771865699059 28.316320599915912, 104.45871788042604 28.244885379556763, 104.44564210030285 28.117045719184773, 104.29463913978464 28.048640396637154, 104.56724498656706 27.844953486914051, 104.88164141332072 27.915506909416479, 105.04496295087966 28.1020489017356, 105.26718843669715 27.999963360620768, 105.30375009658985 27.71270991123356, 105.47384862471444 27.778828225442396, 105.63385524772167 27.662943407712248, 106.3351621132411 27.822175191032386, 106.20236076004124 28.137858961322195, 105.87494011579389 28.126664069191577, 105.81872394615334 28.310338251209487, 105.63593633559361 28.320305815161419, 105.62019501528789 28.522390513411608, 105.89903025544209 28.609272795003676, 105.96251404079055 28.764686680146326, 106.37474699257984 28.511202798770285, 106.22167262898881 28.892880148200447, 105.98070147119608 28.982076329659037, 105.89823486984352 28.900341729687227, 105.79059705830775 28.943570945243096, 105.71761695196096 29.290537871225922, 105.47332360769849 29.278815840578773, 105.31563906029459 29.454479958983086, 105.38270335607518 29.677080636562266, 105.73152862404692 29.864889518236851, 105.74296514242758 30.034763574679403, 105.53241213461251 30.16872167996172, 105.64101073775549 30.190327197842066, 105.62047151544823 30.278582460911991, 105.7203036846675 30.2520658091899, 105.81537368015137 30.440118193999638, 106.15645207920028 30.313871874187782, 106.23069628790353 30.187596271550831, 106.55250128110941 30.31799512997145, 106.72653356437269 30.028474971742696, 107.05183330416384 30.040914601128122, 107.5110113775732 30.646715505016687, 107.41888369762472 30.743299932745856, 107.47540258985782 30.839120214626348, 107.71044531240142 30.891367644601303, 107.84429803422705 30.795094251898377, 107.94976793194468 30.875739690134765, 108.08347382415781 31.202552005071141, 108.01374336586383 31.24710744455308, 108.17471409358075 31.327810728982115, 108.18371471276396 31.492027865393823, 108.54095798941984 31.668859492671629, 108.25382291779357 31.970113941105637, 108.44215986608515 32.061301868186831, 108.36358240180658 32.177537804626127, 108.50404929194144 32.203348438180058, 108.46595447232124 32.272692405630153, 108.06504647621409 32.2352176631648, 107.973685594215 32.14823576906565, 107.64475185861158 32.415192314873593, 107.45215181715281 32.420753380664166, 107.42670636500691 32.538566671314982, 107.26326009867478 32.408174296107063, 107.11948963713724 32.482242313232348, 107.05867899214195 32.712196843409743, 106.72833555843943 32.741215084408793, 106.39731045211585 32.618977802883478, 106.10736426704744 32.722854628038817, 106.0461207738548 32.879373817747648, 105.59166955420676 32.701137464722365, 105.42989130723822 32.93471016804, 105.44999703923213 32.738686665657269, 105.29130376905385 32.657929394026496, 104.73562623226496 32.637596531954557, 104.29173089776287 32.835945473405047, 104.28392494068362 32.944202095850187, 104.42335083137596 33.018281561345134, 104.33007179707596 33.045140121819315, 104.29924581983892 33.304926998882081, 104.43331180599523 33.324742960319554, 104.21705978178369 33.406244050422742, 104.1046590356861 33.665253557106155, 103.54279026375985 33.673108124340615, 103.5183512141374 33.811152116776952, 103.33379066570683 33.744100092245617, 103.15789143664068 33.808532585010937, 103.17103429809458 34.086154192761967, 102.90795069886582 34.314536754767573, 102.5971408799478 34.153033390978351, 102.65649174989454 34.076276671631263, 102.43573141707139 34.088704473133077, 102.30670993691422 33.975819650756421)}, (106.07979850040067 32.762914050842937, 106.07300836894126 32.775322653617764, 106.08472704691587 32.774385453925731, 106.07979850040067 32.762914050842937))" }]
var selectedIfo;
var map;
var baseMap_roadLayer;//矢量地图底图
var baseMap_annoLayer;//地图注记图层
var baseMap_imageLayer;//地图卫星图层
var baseMap_imgannoLayer;
var baseMap_border;
var siChuanShengBorderLayer;//四川省边界图层
dojo.require("esri.layers.graphics");

    




//矢量地图和卫星地图切换
function showLayer(s) {
    if (s == 'jd') {//jd表示矢量地图
        //alert("sd");
        baseMap_roadLayer.show();
        baseMap_annoLayer.show();
        baseMap_imageLayer.hide();
        baseMap_imgannoLayer.hide();
        baseMap_border.hide();
        map.infoWindow.hide();
    }
    else if (s == 'wx') {//wx表示卫星地图
        //alert("wx");
        baseMap_roadLayer.hide();
        baseMap_annoLayer.hide();
        baseMap_imageLayer.show();
        baseMap_imgannoLayer.show();
        baseMap_border.show();
        map.infoWindow.hide();
        map.setLevel(7);
    }else if (s == 'jdhide') {
        baseMap_roadLayer.hide();
        baseMap_annoLayer.hide();
        baseMap_imageLayer.hide();
        baseMap_imgannoLayer.hide();
        baseMap_border.hide();
        map.infoWindow.hide();
        map.setLevel(7);
    }else if (s == 'wxhide') {
        baseMap_roadLayer.hide();
        baseMap_annoLayer.hide();
        baseMap_imageLayer.hide();
        baseMap_imgannoLayer.hide();
        baseMap_border.hide();
        map.infoWindow.hide();
        map.setLevel(7);
    }
}

//分页
function pagerFilter(data) {
    if (typeof data.length == 'number' && typeof data.splice == 'function') {    // 判断数据是否是数组
        data = {
            total: data.length,
            rows: data
        }
    }
    var dg = $(this);
    var opts = dg.datagrid('options');
    var pager = dg.datagrid('getPager');
    pager.pagination({
        onSelectPage: function (pageNum, pageSize) {
            opts.pageNumber = pageNum;
            opts.pageSize = pageSize;
            pager.pagination('refresh', {
                pageNumber: pageNum,
                pageSize: pageSize
            });
            dg.datagrid('loadData', data);
        }
    });
    if (!data.originalRows) {
        data.originalRows = (data.rows);
    }
    var start = (opts.pageNumber - 1) * parseInt(opts.pageSize);
    var end = start + parseInt(opts.pageSize);
    data.rows = (data.originalRows.slice(start, end));
    return data;
}
function addSiChuanShengBorder() {
    require([
        "esri/map", "extras/ThematicLayer", "dojo/domReady!"
    ], function(Map, ThematicLayer) {
        //流域专题图图层
        var Identifier1 = "SiChuan_Bound";
        var tileMatrixSet1 = "Custom_SiChuan_Bound";
        var extent1 = new esri.geometry.Extent(97.35097729486642, 26.049047744957647, 109.53082999606099, 34.31453675476757, new esri.SpatialReference({ wkid: 4326 }));
        var baseurl1 = "http://112.74.101.152:8090/iserver/services/map-SiChuan_Bound/wmts_tianditu";
        var origin1 = { "x": 97.35097729486642, "y": 34.31453675476757 }; //x:100.96736581498045     y:32.53580121915098 
        var url1 = baseurl1 + "?SERVICE=WMTS&VERSION=1.0.0&REQUEST=GetTile&LAYER=" + Identifier1 + "&STYLE=default&FORMAT=image/png&TILEMATRIXSET=" + tileMatrixSet1;
        var water_basinlayer = new ThematicLayer(extent1, url1, origin1);
        map.addLayer(water_basinlayer);
    });
}

$(function() {
    //gis界面部分控制
    //地图类别切换
    $("#check-btn").on('click', function() {
        $('#checkbox').fadeToggle();
    })
    //点击数据、图标按钮对下方表格的控制    
    $("#tab3 .tabs-wrap .tabs li").click(function () {
        if ($('#aui-slide').hasClass('auiactive')) {
            
        } else {
            $('#tab3').animate({ bottom: "0px" });
            $('#aui-panel').animate({ bottom: "288px" });
            $('#aui-slide').animate({ bottom: "240px" });
            $('#aui-slide').addClass('auiactive');
        }
    });

    //下方  数据 图表
    $('#aui-slide').on('click', function() {
        if ($(this).hasClass('auiactive')) {
            $('#tab3').animate({ bottom: "-252px" });
            $('#aui-panel').animate({ bottom: "30px" });
            $(this).animate({ bottom: "-13px" });
            //$(".aui-panel-title").animate({ bottom: "30px" });
            $(this).removeClass('auiactive');
        } else {
           
            $('#tab3').animate({ bottom: "0px" });
            $('#aui-panel').animate({ bottom: "288px" });
            $(this).animate({ bottom: "240px" });
            //$(".aui-panel-title").animate({ bottom: "0px" });
            
            $(this).addClass('auiactive');

        }
    });

    //左侧 图例
    $('#aui-panel-tool').on('click', function() {
        $(this).toggleClass('aui-p-active');
        if ($(this).hasClass('aui-p-active')) {
            $('#aui-panel').animate({ left: "-137px" });
        } else {
            $('#aui-panel').animate({ left: "0px" });
        }
    });
    //右侧 table
    $('#tab-slide').on('click', function() {

        $(this).toggleClass('aui-tab-active');
        if ($(this).hasClass('aui-tab-active')) {
            $('#tab1,#tab2').animate({ right: "10px" });
            $('#aui-chk').animate({ right: "235px" });
        } else {
            $('#tab1,#tab2').animate({ right: "-220px" });
            $('#aui-chk').animate({ right: "5px" });
        }
    });

    //$(".mapChange").on("click", ".streetMap", function() {
    //    $(this).css({ "background": "#4c8fed" }).siblings().css({ "background": "#bbb" });
    //    selectedIfo = 'jd';
    //    showLayer(selectedIfo);
    //});
    //$(".mapChange").on("click", ".satelliteMap", function() {
    //    $(this).css({ "background": "#4c8fed" }).siblings().css({ "background": "#bbb" });
    //    selectedIfo = 'wx';
    //    showLayer(selectedIfo);
    //});
    $("#checkbox li").on("click", function () {
        if (($(this).find("input[type=checkbox]").is(":checked")) == true) {
            $(this).siblings().find("input").prop("checked", false);
            if ($(this).index() == 0) {
                //流域蕴含量
            } else {
                //区域蕴含量
            }
        }
    });
    $("#charTypes").hide();
    $("#numberType").hide();
    $("#dateType").hide();
});

//添加专题图，参数layername:图层名称;identifier:专题图标识符;tileMatrixSet:专题图矩阵集名称;url:wmts服务地址;extent:图层范围;layerVisible:图层是否可见(true or false);
function addThematicLayer(layerName, identifier, tileMatrixSet, url, extent, layerVisible, layerid) {

    require([
        "esri/map", "esri/layers/WMTSLayer", "esri/layers/WMTSLayerInfo", "esri/geometry/Extent", "esri/layers/TileInfo", "esri/SpatialReference", "dojo/domReady!"
    ],
    function (Map, WMTSLayer, WMTSLayerInfo, Extent, TileInfo, SpatialReference
       ) {
        var tileInfo = new TileInfo({
            "dpi": 90.7142857142857,
            "format": "image/png",
            "compressionQuality": 0,
            "spatialReference": new SpatialReference({
                "wkid": 4326   //
            }),
            "rows": 256,
            "cols": 256,
            "origin": {
                "x": 90.0,
                "y": -180
            },
            "lods": [
                {
                    "level": "0",
                    "scale": 5.0E8,
                    "resolution": 1.25764139776733
                }, {
                    "level": "1",
                    "scale": 2.5E8,
                    "resolution": 0.628820698883665
                }, {
                    "level": "2",
                    "scale": 1.0E8,
                    "resolution": 0.251528279553466
                }, {
                    "level": "3",
                    "scale": 5.0E7,
                    "resolution": 0.125764139776733
                }, {
                    "level": "4",
                    "scale": 2.5E7,
                    "resolution": 0.0628820698883665
                },
            {
                "level": "5",
                "scale": 1.0E7,
                "resolution": 0.0251528279553466
            }, {
                "level": "6",
                "scale": 5000000.0,
                "resolution": 0.0125764139776733
            }, {
                "level": "7",
                "scale": 2500000.0,
                "resolution": 0.00628820698883665
            }, {
                "level": "8",
                "scale": 1000000.0,
                "resolution": 0.00251528279553466
            }, {
                "level": "9",
                "scale": 500000.0,
                "resolution": 0.00125764139776733
            }, {
                "level": "10",
                "scale": 250000.0,
                "resolution": 6.28820698883665E-4
            }, {
                "level": "11",
                "scale": 100000.0,
                "resolution": 2.51528279553466E-4
            }, {
                "level": "12",
                "scale": 50000.0,
                "resolution": 1.25764139776733E-4
            }, {
                "level": "13",
                "scale": 25000.0,
                "resolution": 6.28820698883665E-5
            }, {
                "level": "14",
                "scale": 10000.0,
                "resolution": 2.51528279553466E-5
            }, {
                "level": "15",
                "scale": 5000.0,
                "resolution": 1.25764139776733E-5
            }, {
                "level": "16",
                "scale": 2500.0,
                "resolution": 6.28820698883665E-6
            }, {
                "level": "17",
                "scale": 1000.0,
                "resolution": 2.51528279553466E-6
            }, {
                "level": "18",
                "scale": 500.0,
                "resolution": 1.25764139776733E-6
            }]
        });
        //var tileExtent2 = new Extent(1.0837069920436464E7, 3005153.983213887, 1.2082768022408325E7, 4071142.6707240213, new SpatialReference({    //
        //    wkid: 3857
        //}));
        var layerInfo = new WMTSLayerInfo({
            tileInfo: tileInfo,
            fullExtent: extent,
            initialExtent: extent,
            identifier: identifier,   //
            tileMatrixSet: tileMatrixSet,   //  
            format: "png",
            style: "default"   //
        });

        var resourceInfo = {
            version: "1.0.0",
            layerInfos: [layerInfo]
            //  copyright: ""
        };

        var options = {
            serviceMode: "KVP",
            resourceInfo: resourceInfo,
            layerInfo: layerInfo,
            id: layerid
        };

        layerName = new WMTSLayer(url, options);
        map.addLayer(layerName);
        layerName.visible = layerVisible;


    });



}
//添加专题图，参数layername:图层名称;identifier:专题图标识符;tileMatrixSet:专题图矩阵集名称;url:wmts服务地址;extent:图层范围;layerVisible:图层是否可见(true or false);
function addThematicLayer_web(identifier, tileMatrixSet, url, extent, layerVisible, layerid) {
  
    require([
        "esri/map", "esri/layers/WMTSLayer", "esri/layers/WMTSLayerInfo", "esri/geometry/Extent", "esri/layers/TileInfo", "esri/SpatialReference", "dojo/domReady!"
    ],
    function (Map, WMTSLayer, WMTSLayerInfo, Extent, TileInfo, SpatialReference
       ) {
        
        var tileInfo = new TileInfo({
            "dpi": 90.7142857142857,
            "format": "image/png",
            "compressionQuality": 0,
            "spatialReference": new SpatialReference({
                "wkid": 3857   //
            }),
            "rows": 256,
            "cols": 256,
            "origin": {
                "x": -2.0037508342787E7,
                "y": 2.0037508342787E7
            },
            "lods": [
                {
                    "level": "0",
                    "scale": 5.590822640287178E8,
                    "resolution": 156543.033928041
                }, {
                    "level": "1",
                    "scale": 2.795411320143589E8,
                    "resolution": 78271.5169640205
                }, {
                    "level": "2",
                    "scale": 1.3977056600717944E8,
                    "resolution": 39135.75848201025
                }, {
                    "level": "3",
                    "scale": 6.988528300358972E7,
                    "resolution": 19567.879241005125
                }, {
                    "level": "4",
                    "scale": 3.494264150179486E7,
                    "resolution": 9783.939620502562
                },
            {
                "level": "5",
                "scale": 1.747132075089743E7,
                "resolution": 4891.969810251281
            }, {
                "level": "6",
                "scale": 8735660.375448715,
                "resolution": 2445.9849051256406
            }, {
                "level": "7",
                "scale": 4367830.1877243575,
                "resolution": 1222.9924525628203
            }, {
                "level": "8",
                "scale": 2183915.0938621787,
                "resolution": 611.4962262814101
            }, {
                "level": "9",
                "scale": 1091957.5469310894,
                "resolution": 305.7481131407051
            }, {
                "level": "10",
                "scale": 545978.7734655447,
                "resolution": 152.87405657035254
            }, {
                "level": "11",
                "scale": 272989.38673277234,
                "resolution": 76.43702828517627
            }, {
                "level": "12",
                "scale": 136494.69336638617,
                "resolution": 38.218514142588134
            }, {
                "level": "13",
                "scale": 68247.34668319309,
                "resolution": 19.109257071294067
            }, {
                "level": "14",
                "scale": 34123.67334159654,
                "resolution": 9.554628535647034
            }, {
                "level": "15",
                "scale": 17061.83667079827,
                "resolution": 4.777314267823517
            }
            , {
                "level": "16",
                "scale": 8530.918335399136,
                "resolution": 9.554628535647034
            }
            , {
                "level": "17",
                "scale": 4265.459167699568,
                "resolution": 9.554628535647034
            }
            , {
                "level": "18",
                "scale": 2132.729583849784,
                "resolution": 9.554628535647034
            }]
        });
        //var tileExtent2 = new Extent(1.0837069920436464E7, 3005153.983213887, 1.2082768022408325E7, 4071142.6707240213, new SpatialReference({    //
        //    wkid: 3857
        //}));
        var layerInfo = new WMTSLayerInfo({
            tileInfo: tileInfo,
            fullExtent: extent,
            initialExtent: extent,
            identifier: identifier,   //
            tileMatrixSet: tileMatrixSet,   //  
            format: "png",
            style: "default"   //
        });

        var resourceInfo = {
            version: "1.0.0",
            layerInfos: [layerInfo]
            //  copyright: ""
        };

        var options = {
            serviceMode: "KVP",
            resourceInfo: resourceInfo,
            layerInfo: layerInfo,
            id: layerid
        };

        var a = new WMTSLayer(url, options);
        map.addLayer(a);
        a.visible = layerVisible;
    });



}

//能源规划——获取图层右上角的坐标
function getLayerTransform(layer) {
    // var layer = document.getElementById(layerid);

    var xorigin, yorigin, layerstyle = layer.style;
    //chrome
    if (layerstyle['-webkit-transform']) {
        var s = layerstyle['-webkit-transform'];//格式为"translate(0px, 0px)"
        var xyarray = s.replace(/translate\(|px|\s|\)/, '').split(',');
        xorigin = parseInt(xyarray[0]);
        yorigin = parseInt(xyarray[1]);
    }
        //firefox
    else if (layerstyle['transform']) {
        //layer.style['transform'] 格式为"translate3d(xpx,ypx,zpx)" 这样的字符串，现在通过匹配转为[z,y,z]的数组,分别将 px,translate3d,空格
        // var xyzarray=layerstyle.replace(/px/g,'').replace(/ /g,'').replace('translate3d(','').replace(')','').split(',')
        var layertransforstring = layerstyle['transform'];
        var xyz = layertransforstring.replace(/px|\s|translate3d\(|px|\)/g, '').split(',');
        xorigin = parseInt(xyz[0]);
        yorigin = parseInt(xyz[1]);
    }
        //ie 8+
    else {
        xorigin = parseInt(layer.style.left.replace('px', ''));
        yorigin = parseInt(layer.style.top.replace('px', ''));
    }
    console.log("zheshi" + xorigin + "feng" + yorigin);
    return {
        x: xorigin,
        y: yorigin
    }
}

//模糊查询，DatasetArray查询的数组，InputText输入的信息
function LikeQuery(datasetArray, inputText) {
    var outputArray = [];
    $.each(datasetArray, function (index, item) {
        var temp = item.Name.indexOf(inputText);
        if (temp > -1) {
            outputArray.push(item);
        }
    });
    return outputArray;
}
//将字符串转化为浮点型,表格排序时候调用
function numberSort(a, b) {
    var number1 = parseFloat(a);
    var number2 = parseFloat(b);
    return (number1 > number2 ? 1 : -1);
}


//datagrid加载过滤列保留2位小数
function formattoFixed(val, row) {
    var num = new Number(val);
    var temp = parseFloat(num.toFixed(2));
    return temp;
}

//为表格设置默认值
function formatdefault(val,row) {
    if (val == null || val == ""||val=="NULL") {
        return "--";
    } else {
        return val;
    }
}
//去掉字符串中的特殊字符
var excludeSpecial = function (s) {
    // 去掉转义字符
    s = s.replace(/[\'\"\\\b\f\n\r\t]/g, '');
    //s = s.replace('\n', '');
    //s = s.replace('\r', '');
    // 去掉特殊字符
    //s = s.replace(/[\@\#\$\%\^\&\*\(\)\{\}\:\"\L\<\>\?\[\]]/);
    return s;
};
//遍历JSON数组，并判断每一个节点值，最后返回一个JSON对象
function FormatJsonDefault(jsonArray) {
    var temparray=[];
    $.each(jsonArray, function (number, obj) {
        var array1 = [];
        $.each(obj, function(index, item) {
            if (!item || item == "NULL" || item == '1900-01-01 00:00:00.000' || item == '1900-01-01T00:00:00') {
                array1.push("\""+index + "\""+":" + "\"--\"");
            } else {
                if (typeof(item) == "number") {
                    array1.push("\"" + index + "\"" + ":" + parseFloat(item.toFixed(2)));
                } else {
                    array1.push("\"" + index + "\"" + ":" + "\"" + excludeSpecial(item) + "\"");
                }
            }
        });
        temparray.push("{"+array1+"}");
    });
    var returnarray = "[" + temparray + "]";
    return JSON.parse(returnarray);
}

//遍历JSON对象,初始化空值
function JsonObjDefault(obj) {
    var array1 = [];
    $.each(obj, function (index, item) {
        if (item == null || item == "" || item == "NULL") {
            array1.push("\"" + index + "\"" + ":" + "\"--\"");
        } else {
            if (typeof (item) == "number") {
                array1.push("\"" + index + "\"" + ":" + parseFloat(item.toFixed(2)));
            } else if (typeof (item) == "string") {
                array1.push("\"" + index + "\"" + ":" + "\"" + item + "\"");
            } else {
                array1.push("\"" + index + "\"" + ":" + "\"" + item + "\"");
            }
        }
    });
    var returnarray = "{" + array1 + "}";
    return JSON.parse(returnarray);
}
//简化版的图例选择器,任意选择组合进行查询,field标识代表状态字段，Dataarray标识全局数组，array1图例数组，array2图例选择情况数组
function SelectByArbitrarily(field,dataarray,array1,array2) {
    var temparray = [];//临时存放选择后的数组，用于返回
    $.each(array2, function(index, item) {
        if (item == '0' ) {
            $.each(dataarray, function(num, obj) {
                var state = eval("obj."+field);
                if (state == array1[index]) {
                    temparray.push(obj);
                }
            });
        }
    });
    return temparray;
}



//T自定义获取ID符号
var T = function (id) {
    return "string" == typeof id ? document.getElementById(id) : id;
}
var Bind = function (object, fun) {
    return function () {
        return fun.apply(object, arguments);
    }
}

function AutoComplete(obj, autoObj, arr) {
    this.obj = T(obj); //输入框
    this.autoObj = T(autoObj); //DIV的根节点
    this.value_arr = arr; //不要包含重复值
    this.index = -1; //当前选中的DIV的索引
    this.search_value = ""; //保存当前搜索的字符
}

AutoComplete.prototype = {
    //初始化DIV的位置
    init: function () {
        this.autoObj.style.left = this.obj.offsetLeft + "px";
        this.autoObj.style.top = this.obj.offsetTop + this.obj.offsetHeight + "px";
        this.autoObj.style.width = this.obj.offsetWidth - 2 + 100 + "px"; //减去边框的长度2px   
    },
    //删除自动完成需要的所有DIV
    deleteDIV: function () {
        while (this.autoObj.hasChildNodes()) {
            this.autoObj.removeChild(this.autoObj.firstChild);
        }
        this.autoObj.className = "auto_hidden";
    },
    //设置值
    setValue: function (_this) {
        return function () {
            _this.obj.value = this.seq;
            _this.autoObj.className = "auto_hidden";
        }
    },
    //模拟鼠标移动至DIV时，DIV高亮
    autoOnmouseover: function (_this, _div_index) {
        return function () {
            _this.index = _div_index;
            var length = _this.autoObj.children.length;
            for (var j = 0; j < length; j++) {
                if (j != _this.index) {
                    _this.autoObj.childNodes[j].className = 'auto_onmouseout';
                } else {
                    _this.autoObj.childNodes[j].className = 'auto_onmouseover';
                }
            }
        }
    },
    //更改classname
    changeClassname: function (length) {
        for (var i = 0; i < length; i++) {
            if (i != this.index) {
                this.autoObj.childNodes[i].className = 'auto_onmouseout';
            } else {
                this.autoObj.childNodes[i].className = 'auto_onmouseover';
                this.obj.value = this.autoObj.childNodes[i].seq;
            }
        }
    },
    //响应键盘
    pressKey: function (event) {
        var length = this.autoObj.children.length;
        //光标键"↓"
        if (event.keyCode == 40) {
            ++this.index;
            if (this.index > length) {
                this.index = 0;
            } else if (this.index == length) {
                this.obj.value = this.search_value;
            }
            this.changeClassname(length);
        }
            //光标键"↑"
        else if (event.keyCode == 38) {
            this.index--;
            if (this.index < -1) {
                this.index = length - 1;
            } else if (this.index == -1) {
                this.obj.value = this.search_value;
            }
            this.changeClassname(length);
        }
            //回车键
        else if (event.keyCode == 13) {
            this.autoObj.className = "auto_hidden";
            this.index = -1;
            $("#searchbutton").click();
        } else {
            this.index = -1;
        }
    },
    //程序入口
    start: function (event) {
        if (event.keyCode != 13 && event.keyCode != 38 && event.keyCode != 40) {
            this.init();
            this.deleteDIV();
            this.search_value = this.obj.value;
            var valueArr = this.value_arr;
            valueArr.sort();
            if (this.obj.value.replace(/(^\s*)|(\s*$)/g, '') == "") {
                return;
            } //值为空，退出
            try {
                var reg = new RegExp("(" + this.obj.value + ")", "i");
            } catch (e) {
                return;
            }
            var div_index = 0; //记录创建的DIV的索引
            for (var i = 0; i < valueArr.length; i++) {
                if (reg.test(valueArr[i])) {
                    var div = document.createElement("div");
                    div.className = "auto_onmouseout";
                    div.seq = valueArr[i];
                    div.onclick = this.setValue(this);
                    div.onmouseover = this.autoOnmouseover(this, div_index);
                    div.innerHTML = valueArr[i].replace(reg, "<strong>$1</strong>"); //搜索到的字符粗体显示
                    this.autoObj.appendChild(div);
                    this.autoObj.className = "auto_show";
                    if (div_index > 4) {
                        return;
                    } else {
                        div_index++;
                    }
                }
            }
        }
        this.pressKey(event);
        window.onresize = Bind(this, function () { this.init(); });
    }
}
//地图加载点位  res:数据   layer：需要加载上的图层名 Coordinate:坐标名称 tabtip:图例列表的值 State:规划字段名 
//Type: 坐标字段的类型，有些是一个字段存储的，有些是两个字段，0为一个字段的坐标类型，1为两个字段的坐标
function addpointtomap(res, layer, coordinate,tabtip,State,Type) {
    var layername = eval(layer);
    labelPointGraphicLayer.clear();
    layername.clear();
    borderLayer.clear();
    map.infoWindow.hide();
    //先绑定数据原因：如果没有数据，则返回了，datagrid就不会更新数据
    $('#data_list').datagrid({
        data: res
    });
    if (res.length == 0) return;
    $.each(res, function (index, obj) {
        var polygon;
        var textSymbol;
        if (Type == 0) {
            var temp = eval("obj." + coordinate);
            var wkt = new Wkt.Wkt();
            wkt.read(temp);
            var config = {
                spatialReference: {
                    wkid: 4490
                },
                editable: false
            };
            polygon = wkt.toObject(config);
            textSymbol = new esri.symbol.TextSymbol(obj.Name, new esri.symbol.Font("20pt", esri.symbol.Font.STYLE_NORMAL, esri.symbol.Font.VARIANT_NORMAL, esri.symbol.Font.WEIGHT_BOLD, "YaHei")).setAlign(esri.symbol.TextSymbol.ALIGN_START);
        } else {

            polygon = new esri.geometry.Point(parseFloat(obj.Longitude), parseFloat(obj.Latitude), new esri.SpatialReference({ wkid: 4490 }));
            textSymbol = new esri.symbol.TextSymbol(obj.HydropowerStationName, new esri.symbol.Font("20pt", esri.symbol.Font.STYLE_NORMAL, esri.symbol.Font.VARIANT_NORMAL, esri.symbol.Font.WEIGHT_BOLD, "YaHei")).setAlign(esri.symbol.TextSymbol.ALIGN_START);
        }
        var graphicWeb = new esri.Graphic();
        graphicWeb.geometry = polygon;
        graphicWeb.attributes = obj;
        var state = eval("obj." + State);
        var pointSymbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/builded.png', 15, 15);
        if (tabtip == 0) {
            if (state == '规划') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol("/Css/images/GIS/planning.png", 15, 15);
            } else if (state == '在建') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol("/Css/images/GIS/building.png", 15, 15);
            } else if (state == '已建') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol("/Css/images/GIS/builded.png", 15, 15);
            }
        } else if (tabtip == 1) {
            if (obj.StationScale == '1') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/bigstation.png', 15, 15);
            }
            if (obj.StationScale == '2') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/station.png', 15, 15);
            }
            if (obj.StationScale == '3') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/smallstation.png', 15, 15);
            }
        } else {
            if (obj.Type == '特高压变电站') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/fifthstation.png', 15, 15);
            } else if (obj.Type == '500kV变电站') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/fourthstation.png', 15, 15);
            } else if (obj.Type == '220kV变电站') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/thirdstation.png', 15, 15);
            } else if (obj.Type == '110kV变电站') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/secondstation.png', 15, 15);
            } else if (obj.Type == '35kV变电站') {
                pointSymbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/firststation.png', 15, 15);
            }
        }
        graphicWeb.setSymbol(pointSymbol);
        layername.add(graphicWeb);

        
        textSymbol.setOffset(-50, 20).setColor(new dojo.Color([30, 30, 30, 0.9]));
        //textSymbol.setFont(new esri.symbol.Font(("20pt", esri.symbol.Font.STYLE_ITALIC, esri.symbol.Font.VARIANT_NORMAL, esri.symbol.Font.WEIGHT_BOLD, "Courier")));
        var labelPointGraphic = new esri.Graphic(polygon, textSymbol);
        labelPointGraphicLayer.add(labelPointGraphic);
    });

    require(["esri/graphicsUtils"], function (graphicsUtils) {
        var myExtent = graphicsUtils.graphicsExtent(layername.graphics);
        map.setExtent(myExtent.expand(1.5));
    });
}
//添加边界  code:点击的名字  ArryCity：需要加载的数据数组
function addBorder(code,arryCity) {
    borderLayer.clear();
    map.infoWindow.hide();
    res = arryCity;
    $.each(res, function (idx, obj) {
        if (code == obj.Name) {
            var wkt = new Wkt.Wkt();
            wkt.read(obj.Shape);
            var config = {
                spatialReference: {
                    wkid: 4490 // WGS84 unprojected
                },
                editable: false
            };

            var polygon = wkt.toObject(config);
            var graphicWeb = new esri.Graphic();
            graphicWeb.geometry = polygon;
            graphicWeb.attributes = obj;
            var lineSymbol = new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([200, 50, 50]), 4);
            var polySymbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, lineSymbol, new dojo.Color([255, 255, 255, 0.1]));
            graphicWeb.setSymbol(polySymbol);
            //把图像添加到刚才创建的图层上
            borderLayer.add(graphicWeb);
            // setExtent(graphicWeb);

        }
    }); //end each }); //end each
    require(["esri/graphicsUtils"], function (graphicsUtils) {
        var myExtent = graphicsUtils.graphicsExtent(borderLayer.graphics);
        map.setExtent(myExtent.expand(1.5));
        /* code goes here */
    });
}

//表格的点击事件后执行的操作，显示的infowindow 
//layer 图层对象  单击表格对应的行数据
function datagrid_click(layer, row, type) {
    map.infoWindow.hide();
    $.each(layer.graphics, function (index, item) {
        if (item.attributes.Name == row.Name) {
            var myExtent = item._extent;
            var pt = myExtent.getCenter();
            var content;
            if (type == 0) {
                if (layerClassCode == 0) {
                    content = content_infowindow(item, 0);
                }
                if (layerClassCode == 1) {
                    content = content_infowindow(item, 1);
                }
            } else {
                content = content_infowindow(item, 0);
            }
            map.infoWindow.setContent(content);
            map.infoWindow.setTitle("详情");
            map.infoWindow.show(pt);
            map.centerAndZoom(pt, 7);
            var lineSymbol = new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID, new dojo.Color([0, 255, 255,0.5]),3);
            var polySymbol = new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID, lineSymbol, new dojo.Color([0, 0, 0, 0]));
            item.setSymbol(polySymbol);
            return;
        }
    });
}
//下方列表的点击事件 Layer:加载点位的图层 row：点击获取的表格该行的数据 tabtip:图例列表的状态 Name：用来判断点击行和图层中某个Graphic相同的字段名 Type:存储规划 在建类型的字段名
function datagrid_list(Layer, row, tabtip, Name,Type) {
    map.infoWindow.hide();
    var symbol;
    if (tabtip == 0) {
        if (gra != null) {
            var state = eval("gra.attributes." + Type);
            if (state == '规划') {
                symbol = new esri.symbol.PictureMarkerSymbol("/Css/images/GIS/planning.png", 15, 15);
            } else if (state == '在建') {
                symbol = new esri.symbol.PictureMarkerSymbol("/Css/images/GIS/building.png", 15, 15);
            } else if (state == '已建') {
                symbol = new esri.symbol.PictureMarkerSymbol("/Css/images/GIS/builded.png", 15, 15);
            }
            gra.setSymbol(symbol);
        }
    } else if (tabtip == 1) {
        if (gra != null) {
            if (gra.attributes.StationScale == '1') {
                symbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/bigstation.png', 15, 15);
            }
            if (gra.attributes.StationScale == '2') {
                symbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/station.png', 15, 15);
            }
            if (gra.attributes.StationScale == '3') {
                symbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/smallstation.png', 15, 15);
            }
            gra.setSymbol(symbol);
        }
    } else {
        if (gra != null) {
            if (gra.attributes.Type == '特高压变电站') {
                symbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/fifthstation.png', 15, 15);
            } else if (gra.attributes.Type == '500kV变电站') {
                symbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/fourthstation.png', 15, 15);
            } else if (gra.attributes.Type == '220kV变电站') {
                symbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/thirdstation.png', 15, 15);
            } else if (gra.attributes.Type == '110kV变电站') {
                symbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/secondstation.png', 15, 15);
            } else if (gra.attributes.Type == '35kV变电站') {
                symbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/firststation.png', 15, 15);
            }
            gra.setSymbol(symbol);
        }   
    }
    $.each(Layer.graphics, function (index, item) {
        var obj = eval("item.attributes." + Name);
        var rowname = eval("row." + Name);
        if (obj == rowname) {
            var content = infowindow_content(item);
            map.infoWindow.setContent(content);
            map.infoWindow.setTitle("详情");
            var symbol = new esri.symbol.PictureMarkerSymbol('/Css/images/GIS/station_hover.png', 20, 20);
            item.setSymbol(symbol);
            gra = item;
            var pt = item.geometry;
            map.infoWindow.show(pt);
            map.centerAndZoom(pt, 10);
            return;
        }
    });
}
//根据选择条件进行查询，1代表数值型，表示一点范围；2表示字符型，即模糊查询；3表示时间类型，也表示一段时间范围
function ConditionQuery(stationArray, condition, text1, text2, type) {
    var ex = /^[0-9]*$/;
    var tempArray = [];
    if (type == 1) {
        if (!ex.test(text1) || !ex.test(text2)) {
            alert("请输入正确的数值");
            return null;
        } else if (text1 == '' || text2 == '') {
            alert("查询范围不能为空");
            return null;
        } else if (parseFloat(text1) > parseFloat(text2)) {
            alert("最小值不能大于最大值");
            return null;
        } else {
            $.each(stationArray, function (index, item) {
                var field = eval("item." + condition);
                if (field == undefined) {
                    return null;
                } else {
                    if (parseFloat(text1) <= parseFloat(field) && parseFloat(field) <= parseFloat(text2)) {
                        tempArray.push(item);
                    }
                }
            });
        }
    }else if (type == 2) {
        $.each(stationArray, function(index, item) {
            var field = eval("item." + condition);
            if (field == undefined) {
                return null;
            } else {
                var temp = field.indexOf(text1);
                if (temp > -1) {
                    tempArray.push(item);
                }
            }
        });
    }else if (type == 3) {
        if (text1 == '' || text2 == '') {
            alert("查询范围不能为空");
            return null;
        } else if (Date(text1) > Date(text2)) {
            alert("开始时间不能大于结束时间");
            return null;
        } else {
            $.each(stationArray, function (index, item) {
                var field = eval("item." + condition).substring(0,10);
                if (field == undefined) {
                    return null;
                } else {
                    var startdate = new Date(text1.replace('-', '/').replace('-', '/'));
                    var enddate = new Date(text2.replace('-', '/').replace('-', '/'));
                    var date = new Date(field.replace('-', '/').replace('-', '/'));
                    if (startdate <= date && date <= enddate) {
                        tempArray.push(item);
                    }
                }
            });
        }
    }
    return tempArray;
}
//根据选择条件类型，对查询的方式进行改变
function SelectCondition(conditionarray,typearray) {
    var type = 0;
    var values = $("#dataCondition").combobox("getValue");
    $.each(conditionarray, function (index, item) {
        if (item == values) {
            type = typearray[index];
        }
    });
    if (type == 1) {
        $("#charTypes").hide();
        $("#numberType").show();
        $("#dateType").hide();
    } else if (type == 2) {
        $("#charTypes").show();
        $("#numberType").hide();
        $("#dateType").hide();
    } else if (type == 3) {
        $("#charTypes").hide();
        $("#numberType").hide();
        $("#dateType").show();
    }
    else {
        $("#charTypes").hide();
        $("#numberType").hide();
        $("#dateType").hide();
    }
}